<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shelf Replenish Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 10px;
      font-size: 18px;
    }
    h1 {
      text-align: center;
      margin: 10px 0;
      font-size: 28px;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }
    .top-bar input,
    .top-bar select {
      flex: 1 1 30%;
      padding: 8px;
      font-size: 18px;
      border-radius: 4px;
      border: 1px solid #555;
    }
    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }
    .buttons-row button {
      flex: 1 1 45%;
      padding: 10px;
      font-size: 18px;
      border-radius: 4px;
      border: none;
      background: #444;
      color: #fff;
    }
    .buttons-row button:active {
      background: #666;
    }
    #status {
      font-size: 16px;
      margin-bottom: 4px;
      text-align: center;
    }
    .table-wrapper {
      overflow-x: auto;
      background: #111;
      border-radius: 4px;
      padding: 4px;
      max-height: 65vh;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th,
    td {
      border: 1px solid #333;
      padding: 6px;
      text-align: center;
      font-size: 20px; /* BIG row text */
    }
    th {
      background: #234a84;
      font-size: 20px;
    }
    tr.selected {
      outline: 3px solid #ff0;
    }
    .done-cell.done {
      background: #115511;
    }
    .done-cell.not-done {
      background: #551111;
    }
    .row-buttons button {
      font-size: 16px;
      padding: 4px 6px;
      margin: 0 2px;
      border-radius: 4px;
      border: none;
      color: #fff;
    }
    .row-buttons .edit-btn {
      background: #2d7;
    }
    .row-buttons .delete-btn {
      background: #d33;
    }
    .file-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
      align-items: center;
    }
    .file-row input[type="file"] {
      font-size: 14px;
    }
  </style>

  <!-- Firebase v8 scripts (match the code below) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <h1>Shelf Replenish Tracker</h1>

  <div class="top-bar">
    <input id="in-shelf" placeholder="Shelf (e.g. AA03)" />
    <input id="in-sku" placeholder="SKU (e.g. 2356F)" />
    <input id="in-from" placeholder="From (e.g. FL027)" />
    <input id="in-boxes" type="number" min="0" placeholder="Boxes" />
    <select id="in-status">
      <option value="NOT DONE">NOT DONE</option>
      <option value="DONE">DONE</option>
    </select>
    <input id="in-desc" placeholder="Description (pallet empty, no pallet, etc.)" />
  </div>

  <div class="buttons-row">
    <button id="btn-add">Add row</button>
    <button id="btn-update">Update selected</button>
    <button id="btn-clear-form">Clear form</button>
    <button id="btn-clear-all">Clear ALL rows</button>
    <button id="btn-download">Download CSV</button>
    <button id="btn-save-local">Save to device</button>
  </div>

  <div id="status">Status: Ready</div>

  <div class="table-wrapper">
    <table id="data-table">
      <thead>
        <tr>
          <th>Shelf</th>
          <th>SKU</th>
          <th>From</th>
          <th>Boxes</th>
          <th>Done?</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="file-row">
    <label for="file-input">Load CSV:</label>
    <input type="file" id="file-input" accept=".csv,text/csv" />
  </div>

  <script>
    // ---------- Firebase init (your config) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBSjLtFDNob4ccwa_AWP62luhbXNyQN-kc",
      authDomain: "shelf-tracker-8c090.firebaseapp.com",
      databaseURL: "https://shelf-tracker-8c090-default-rtdb.firebaseio.com",
      projectId: "shelf-tracker-8c090",
      storageBucket: "shelf-tracker-8c090.firebasestorage.app",
      messagingSenderId: "497676127106",
      appId: "1:497676127106:web:b2846fbe26c42c69335d9b",
      measurementId: "G-NEDP05RC65"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const rowsRef = db.ref("rows"); // all rows stored under /rows

    // ---------- App state ----------
    const STORAGE_KEY = "shelf_replenish_data_v1_backup";

    // rows: [{shelf, sku, fromLoc, boxes, status, desc}, ...]
    let rows = [];
    let selectedIndex = null;

    function setStatus(msg) {
      document.getElementById("status").textContent = "Status: " + msg;
    }

    // ---------- local backup (optional) ----------
    function saveToLocal() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
      } catch (e) {
        console.warn("localStorage error:", e);
      }
    }

    function loadFromLocal() {
      try {
        const text = localStorage.getItem(STORAGE_KEY);
        if (text) {
          rows = JSON.parse(text);
        }
      } catch (e) {
        console.warn("localStorage error:", e);
      }
    }

    // ---------- Firebase sync ----------
    function saveToCloud() {
      rowsRef
        .set(rows)
        .then(() => {
          setStatus("Saved to cloud (" + rows.length + " rows).");
        })
        .catch((err) => {
          console.error(err);
          setStatus("Cloud save error: " + err.message);
        });
    }

    function startCloudListener() {
      rowsRef.on(
        "value",
        (snapshot) => {
          const val = snapshot.val();
          if (Array.isArray(val)) {
            rows = val.filter((r) => r); // remove nulls
          } else if (val && typeof val === "object") {
            rows = Object.values(val);
          } else {
            rows = [];
          }
          selectedIndex = null;
          renderTable();
          saveToLocal(); // backup
          setStatus("Loaded from cloud (" + rows.length + " rows).");
        },
        (err) => {
          console.error("Cloud load error:", err);
          setStatus("Cloud load error, using local backup.");
          loadFromLocal();
          renderTable();
        }
      );
    }

    // ---------- Form helpers ----------
    function clearForm() {
      document.getElementById("in-shelf").value = "";
      document.getElementById("in-sku").value = "";
      document.getElementById("in-from").value = "";
      document.getElementById("in-boxes").value = "";
      document.getElementById("in-status").value = "NOT DONE";
      document.getElementById("in-desc").value = "";
    }

    function readForm() {
      let shelf = document.getElementById("in-shelf").value.trim().toUpperCase();
      let sku = document.getElementById("in-sku").value.trim().toUpperCase();
      let fromLoc = document.getElementById("in-from").value.trim().toUpperCase();
      let boxesVal = document.getElementById("in-boxes").value.trim();
      let status = document.getElementById("in-status").value.trim().toUpperCase();
      let desc = document.getElementById("in-desc").value.trim();

      let boxes = boxesVal === "" ? "" : Number(boxesVal);
      if (boxesVal !== "" && Number.isNaN(boxes)) {
        alert("Boxes must be a number.");
        return null;
      }
      if (status !== "DONE" && status !== "NOT DONE") {
        status = "NOT DONE";
      }

      return { shelf, sku, fromLoc, boxes, status, desc };
    }

    // ---------- Table rendering ----------
    function renderTable() {
      const tbody = document.querySelector("#data-table tbody");
      tbody.innerHTML = "";

      rows.forEach((row, idx) => {
        const tr = document.createElement("tr");
        if (idx === selectedIndex) tr.classList.add("selected");

        const tdShelf = document.createElement("td");
        tdShelf.textContent = row.shelf;
        tr.appendChild(tdShelf);

        const tdSku = document.createElement("td");
        tdSku.textContent = row.sku;
        tr.appendChild(tdSku);

        const tdFrom = document.createElement("td");
        tdFrom.textContent = row.fromLoc;
        tr.appendChild(tdFrom);

        const tdBoxes = document.createElement("td");
        tdBoxes.textContent = row.boxes;
        tr.appendChild(tdBoxes);

        const tdDone = document.createElement("td");
        tdDone.textContent = row.status;
        tdDone.classList.add(
          "done-cell",
          row.status === "DONE" ? "done" : "not-done"
        );
        tr.appendChild(tdDone);

        const tdDesc = document.createElement("td");
        tdDesc.textContent = row.desc;
        tr.appendChild(tdDesc);

        const tdActions = document.createElement("td");
        tdActions.classList.add("row-buttons");

        const btnEdit = document.createElement("button");
        btnEdit.textContent = "Edit";
        btnEdit.classList.add("edit-btn");
        btnEdit.addEventListener("click", () => selectRow(idx));
        tdActions.appendChild(btnEdit);

        const btnDel = document.createElement("button");
        btnDel.textContent = "Del";
        btnDel.classList.add("delete-btn");
        btnDel.addEventListener("click", () => deleteRow(idx));
        tdActions.appendChild(btnDel);

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });
    }

    function selectRow(idx) {
      selectedIndex = idx;
      const row = rows[idx];
      document.getElementById("in-shelf").value = row.shelf;
      document.getElementById("in-sku").value = row.sku;
      document.getElementById("in-from").value = row.fromLoc;
      document.getElementById("in-boxes").value =
        row.boxes === "" ? "" : String(row.boxes);
      document.getElementById("in-status").value = row.status;
      document.getElementById("in-desc").value = row.desc;
      renderTable();
      setStatus("Editing row " + (idx + 1) + " (Update to save).");
    }

    function deleteRow(idx) {
      if (!confirm("Delete this row?")) return;
      rows.splice(idx, 1);
      selectedIndex = null;
      saveToLocal();
      saveToCloud();
      renderTable();
      setStatus("Row deleted.");
    }

    // ---------- CSV helpers ----------
    function toCSV() {
      const header = ["Shelf", "SKU", "From", "Boxes", "Done?", "Description"];
      const lines = [header.join(",")];
      rows.forEach((r) => {
        const vals = [
          r.shelf,
          r.sku,
          r.fromLoc,
          r.boxes,
          r.status,
          r.desc,
        ].map((v) => {
          v = String(v ?? "");
          if (v.includes(",") || v.includes('"')) {
            v = '"' + v.replace(/"/g, '""') + '"';
          }
          return v;
        });
        lines.push(vals.join(","));
      });
      return lines.join("\n");
    }

    function downloadCSV() {
      const csv = toCSV();
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "shelf_replenish.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("CSV downloaded.");
    }

    function loadCSVFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.split(/\r?\n/).filter((l) => l.trim().length > 0);
        const newRows = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          const parts = line.split(",");
          const [shelf, sku, fromLoc, boxesRaw, statusRaw, ...rest] = parts;
          const desc = rest.join(",") || "";
          let boxes = boxesRaw ? Number(boxesRaw) : "";
          if (Number.isNaN(boxes)) boxes = "";
          const status = (statusRaw || "").trim().toUpperCase();
          newRows.push({
            shelf: (shelf || "").trim().toUpperCase(),
            sku: (sku || "").trim().toUpperCase(),
            fromLoc: (fromLoc || "").trim().toUpperCase(),
            boxes,
            status: status === "DONE" ? "DONE" : "NOT DONE",
            desc: (desc || "").trim(),
          });
        }
        rows = newRows;
        selectedIndex = null;
        saveToLocal();
        saveToCloud();
        renderTable();
        setStatus("CSV loaded (" + rows.length + " rows).");
      };
      reader.readAsText(file);
    }

    // ---------- Button events ----------
    document.getElementById("btn-add").addEventListener("click", () => {
      const data = readForm();
      if (!data) return;
      rows.push(data);
      selectedIndex = rows.length - 1;
      saveToLocal();
      saveToCloud();
      renderTable();
      clearForm();
      setStatus("Row added (" + rows.length + " total).");
    });

    document.getElementById("btn-update").addEventListener("click", () => {
      if (selectedIndex === null) {
        setStatus("Select a row first (tap Edit).");
        return;
      }
      const data = readForm();
      if (!data) return;
      rows[selectedIndex] = data;
      saveToLocal();
      saveToCloud();
      renderTable();
      clearForm();
      selectedIndex = null;
      setStatus("Row updated.");
    });

    document.getElementById("btn-clear-form").addEventListener("click", () => {
      clearForm();
      selectedIndex = null;
      renderTable();
      setStatus("Form cleared.");
    });

    document.getElementById("btn-clear-all").addEventListener("click", () => {
      if (!confirm("Clear ALL rows?")) return;
      rows = [];
      selectedIndex = null;
      saveToLocal();
      saveToCloud();
      renderTable();
      setStatus("All rows cleared.");
    });

    document.getElementById("btn-download").addEventListener("click", () => {
      downloadCSV();
    });

    document.getElementById("btn-save-local").addEventListener("click", () => {
      saveToLocal();
      setStatus("Saved local backup.");
    });

    document.getElementById("file-input").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        loadCSVFile(file);
        e.target.value = "";
      }
    });

    // ---------- Init ----------
    loadFromLocal();
    renderTable();
    startCloudListener();
  </script>
</body>
</html>

